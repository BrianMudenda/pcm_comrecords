<!DOCTYPE html>
<html>
<head>
    <title>My Committee Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial; background: #eaf0e6; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #1e4a3a; color: white; }
        input, textarea { width: 100%; padding: 5px; box-sizing: border-box; }
        button { background: #1e4a3a; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .logout { background: #a33; }
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .form-row input { flex: 1; min-width: 150px; }
    </style>
</head>
<body>
    <div class="container">
        <h2 id="committeeName">Committee Dashboard</h2>
        <button onclick="logout()" class="logout">Logout</button>

        <h3>Add New Record</h3>
        <div class="form-row">
            <input type="text" id="strategic_theme" placeholder="Strategic Theme" />
            <input type="text" id="initiatives" placeholder="Initiatives" />
            <input type="text" id="kpi_measures" placeholder="KPI (Measures)" />
            <input type="text" id="quarter" placeholder="Quarter" />
        </div>
        <div class="form-row">
            <input type="text" id="responsible_committee" placeholder="Responsible Committee" />
            <input type="text" id="timing" placeholder="Timing" />
            <input type="number" id="budget" placeholder="Budget" step="0.01" />
            <input type="number" id="variance" placeholder="Variance" step="0.01" />
        </div>
        <div class="form-row">
            <textarea id="comments" placeholder="Comments" rows="2" style="width:100%;"></textarea>
        </div>
        <button onclick="addRecord()">Add Record</button>

        <h3>My Records</h3>
        <table id="recordsTable">
            <thead>
                <tr>
                    <th>Timestamp</th><th>Strategic Theme</th><th>Initiatives</th><th>KPI</th><th>Quarter</th>
                    <th>Responsible</th><th>Timing</th><th>Budget</th><th>Variance</th><th>Comments</th><th>Actions</th>
                </tr>
            </thead>
            <tbody id="recordsBody"></tbody>
        </table>
    </div>

    <script>
        const supabase = supabase.createClient(
            'https://cfwrxwzqfbegmqlxldyz.supabase.co', // REPLACE
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmd3J4d3pxZmJlZ21xbHhsZHl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Mjk4OTEsImV4cCI6MjA4NzEwNTg5MX0.5fZdC5W8S-8O0nrhelhvaSDxMMc45M6xFLO45xKx_q8'                      // REPLACE
        );

        let currentUser = null;
        let committeeId = null;

        async function init() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            currentUser = user;

            // Get committee_id from profiles
            const { data: profile } = await supabase
                .from('profiles')
                .select('committee_id, committees(name)')
                .eq('id', user.id)
                .single();

            if (profile) {
                committeeId = profile.committee_id;
                document.getElementById('committeeName').innerText = profile.committees.name + ' Dashboard';
            } else {
                alert('No committee assigned. Contact admin.');
                logout();
            }

            loadRecords();
        }

        async function loadRecords() {
            const { data, error } = await supabase
                .from('records')
                .select('*')
                .eq('committee_id', committeeId)
                .order('timestamp', { ascending: false });

            if (error) console.error(error);
            else renderRecords(data);
        }

        function renderRecords(records) {
            const tbody = document.getElementById('recordsBody');
            tbody.innerHTML = '';
            records.forEach(rec => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(rec.timestamp).toLocaleString()}</td>
                    <td>${rec.strategic_theme || ''}</td>
                    <td>${rec.initiatives || ''}</td>
                    <td>${rec.kpi_measures || ''}</td>
                    <td>${rec.quarter || ''}</td>
                    <td>${rec.responsible_committee || ''}</td>
                    <td>${rec.timing || ''}</td>
                    <td>${rec.budget || ''}</td>
                    <td>${rec.variance || ''}</td>
                    <td>${rec.comments || ''}</td>
                    <td>
                        <button onclick="editRecord(${rec.id})">Edit</button>
                        <button onclick="deleteRecord(${rec.id})">Del</button>
                    </td>
                `;
            });
        }

        async function addRecord() {
            const newRecord = {
                committee_id: committeeId,
                strategic_theme: document.getElementById('strategic_theme').value,
                initiatives: document.getElementById('initiatives').value,
                kpi_measures: document.getElementById('kpi_measures').value,
                quarter: document.getElementById('quarter').value,
                responsible_committee: document.getElementById('responsible_committee').value,
                timing: document.getElementById('timing').value,
                budget: document.getElementById('budget').value ? parseFloat(document.getElementById('budget').value) : null,
                variance: document.getElementById('variance').value ? parseFloat(document.getElementById('variance').value) : null,
                comments: document.getElementById('comments').value
            };

            const { error } = await supabase.from('records').insert(newRecord);
            if (error) alert(error.message);
            else {
                // Clear form
                document.querySelectorAll('input, textarea').forEach(el => el.value = '');
                loadRecords();
            }
        }

        async function deleteRecord(id) {
            if (confirm('Delete this record?')) {
                const { error } = await supabase.from('records').delete().eq('id', id);
                if (error) alert(error.message);
                else loadRecords();
            }
        }

        function editRecord(id) {
            // For simplicity, prompt for each field â€“ you can improve later
            const newStrategic = prompt('Strategic Theme:');
            if (newStrategic !== null) {
                supabase.from('records').update({ strategic_theme: newStrategic }).eq('id', id).then(() => loadRecords());
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        }

        init();
    </script>
</body>
</html>